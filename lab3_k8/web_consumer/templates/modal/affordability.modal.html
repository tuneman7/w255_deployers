
<style>

  .on_top_always {
    z-index: 999 !important;
  }
  
  </style>

<br/>
<br/>
<br/>
{% if form is not none %}

<!--Don Irwin use this on the tool tip so that it will be on top always-->


<div class="container">
  <table class="align-bottom"  >
    <tr>
      <td>
        <h1 id="section_tag">What can I afford?</h1>
      </td>
      <td>&nbsp;&nbsp;</td>
      <td>
        <h3 ><p style="vertical-align: bottom">(Mortgage only -- other carrying costs excluded)</p></h3>
      </td>
      <td>&nbsp;&nbsp;</td>
      <td class="align-bottom" style="vertical-align: bottom" >
        <h4><a style="vertical-align: bottom" onClick="javascript:render_amortization_modal();">View Amortization Schedule.</a> </h4>
      </td>      
    </tr>
  </table>

  

  <table class="table">
      <tr >
          <td id="world_event_table" >
              <span class="align-middle">
                  <form method="post" class="form" action="/section_four" id="affordability_calc" name="affordability_calc">
                  <table class="table table-responsive-md table-striped table-hover ">
                      <thead class="thead-dark">
                      <tr>
                          <th scope="col">Affordability Question</th>
                          <th scope="col">Value</th>
                      </tr>
                      </thead>
                      <tbody>
                          
                          <tr class="pointer">
                            <td>
                              What is your monthly budget for the mortgage payment?
                            </td>
                            <td>
                              {{ form.monthly_allocation(**{"onchange":"refresh_charts(this.form.loan_term.value,this.form.interest_rates.value,this.form.downpayment_amt.value,this.form.monthly_allocation.value)"}) }}
                            </td>
                          </tr>
                          <tr class="pointer">
                            <td>
                              What is the current interest rate?
                            </td>
                            <td>
                              {{ form.interest_rates(**{"onchange":"refresh_charts(this.form.loan_term.value,this.form.interest_rates.value,this.form.downpayment_amt.value,this.form.monthly_allocation.value)"}) }}
                            </td>
                          </tr>
                          <tr class="pointer">
                            <td>
                              What percentage downpayment do you plan to make?
                            </td>
                            <td>
                              {{ form.downpayment_amt(**{"onchange":"refresh_charts(this.form.loan_term.value,this.form.interest_rates.value,this.form.downpayment_amt.value,this.form.monthly_allocation.value)"}) }}

                            </td>
                          </tr>
                          <tr class="pointer">
                            <td>
                              What is the term of your loan?
                            </td>
                            <td>
                              {{ form.loan_term(**{"onchange":"refresh_charts(this.form.loan_term.value,this.form.interest_rates.value,this.form.downpayment_amt.value,this.form.monthly_allocation.value)"}) }}
                            </td>
                          </tr>
                          <tr>
                            <td colspan="2">
                                    <div id="altair-timeseries1"></div>
                                  </div>
                                  <!-- Placeholder for the tooltip -->
                                  <div id="vis-tooltip" class="vg-tooltip on_top_always"></div>
                                  </div>
                                  <!-- Render Charts -->
                                  <script type="text/javascript">
                                  function parse(url, div) {
                                  var opt = { mode: "vega-lite",
                                      renderer: "svg",
                                      actions: { export: true, source: false, editor: false }
                                      };
                                  vegaEmbed("#" + div, url, opt, function (error, result) {
                                    vegaTooltip.vegaLite(result.view, url);
                                    });
                                    }
                                  //Parse your Json variable here
                                  parse({{ chart_json1 | safe }}, "altair-timeseries1")
                                  </script>            
            
                            </td>
                          </tr>

                          <!--
                          <tr>
                            <td colspan="3" align="right">
                              <button type="button" class="btn btn-primary" onclick="refresh_charts(this.form.interest_rates.value,this.form.downpayment_amt.value,this.form.monthly_allocation.value)">What can I Afford?</button>
                            </td>
                          </tr>
                          -->
                      </tbody>
                  </table>
                {{ form.csrf_token }}
                  </form>

              </span>
      

          </td>
          <td>
              <center>
                <h2>You can afford a {{ house_price }} house.</h2>
              </center>
              <div id="world_detail_render_area">
              <div id="altair-timeseries"></div>
              </div>
              <!-- Placeholder for the tooltip -->
              <div id="vis-tooltip" class="vg-tooltip on_top_always"></div>
              </div>
              <!-- Render Charts -->
              <script type="text/javascript">
              function parse(url, div) {
              var opt = { mode: "vega-lite",
                  renderer: "svg",
                  actions: { export: true, source: false, editor: false }
                  };
              vegaEmbed("#" + div, url, opt, function (error, result) {
                vegaTooltip.vegaLite(result.view, url);
                });
                }
              //Parse your Json variable here
              parse({{ chart_json | safe }}, "altair-timeseries")
              </script>            
              

                  <div class="container-fluid" id="event_detail_rendering" style="display:none">
                      <div class="row">
                          <div class="col-md-2">
                              <img src="./static/images/back-button-svgrepo-com.svg" width="40" height="40" onclick="back_to_list()" id="move_back"/>
                          </div>
                          <div class="col-md-8 text-center"><a onclick="back_to_events()">Back to Events</a></div>
                          <div class="col-md-2 float-right">
                              <img src="./static/images/back-button-svgrepo-com.svg" width="40" height="40" style="transform:rotate(180deg)" class="float-end" id="move_forward" onclick="move_forward()"/>
                          </div>
                      </div>
                      <div class="row">
                          <div class="col-md-12"><br/></div>
                      </div>

                      <div class="row">
                        <div class="col-md-3">
                          <div id="event_detail_text"></div>
                        </div>
                        <div class="col-md-9">
                          <div id="event_render_container"></div>
                        </div>
                      </div>
                    </div>                    

                  </div>
              </div>


          </td>
      </tr>
      <tr>
        <td colspan="2">
          Based on <a href="https://github.com/b3mery/AmortaPy">AmortaPy</a>
        </td>
      </tr>
  </table>

  <div class="modal fade" id="amortization_modal" >
    <div class="modal-dialog modal-lg" >
        <div class="modal-content modal-lg">
            <div class="modal-header modal-lg">
              <button type="button" class="close" data-dismiss="modal">Ã—</button>
                <h4 class="modal-title"><b>Amortization Schedule:</b>  
                  Shows how much is applied to principal or interest over the life of the loan. <br/>
                  To purchase a <b>{{ house_price }}</b> home, a borrower will pay; <b>{{loan_cumulative_interest}}</b> in interest, 
                  <b>{{loan_cumulative_principal}}</b> in principal repayment. <b><u>Paying in total:</u></b> <b>{{total_repayment_amt}}</b>.
                 </h4>
              
            </div>
            <div class="modal-body modal-lg" id="amortization_table_parent">
              <h1>
                <!--Displaying the converted table-->
                  {% for table in tables %}
                  <h2>{{titles[loop.index]}}</h2>							
                  {{ table|safe }}
                  {% endfor %}	
                </h1>        
            </div>
        </div>
    </div>
  </div>


</div>


  <script>

          function render_amortization_modal(){
          $('#amortization_modal').modal('show'); }; 
  

    function set_drop_down_value(drop_down_id,value)
    {
      //console.log(value);
      for (var option of document.getElementById(drop_down_id).options)
        {
          //console.log(option.value);
        if (option.value === value)
        {
            option.selected = true;
            return;
        }
        }

    }

    function refresh_charts(loan_term,interest_rates,downpayment_amt,monthly_allocation){

          page_loading();
          //console.log("bozo")

          $.ajax({
              url: '/section_four_graph',
              type: 'post',
              data: {loan_term,interest_rates : interest_rates, downpayment_amt:downpayment_amt, monthly_allocation:monthly_allocation },
              success: function(data){ 
                  $('#affordability_calc').empty();                 
                  $('#affordability_calc').html(data); 
                  $('#affordability_calc').append(data.htmlresponse); 
                  page_not_loading();
              }
          });
          
        };

      $(document).ready(function () {


          page_not_loading();

          set_drop_down_value("monthly_allocation","{{current_monthly_allocation}}");
          set_drop_down_value("interest_rates","{{current_interest_rate}}");
          set_drop_down_value("downpayment_amt","{{current_downpayment_amount}}");
          set_drop_down_value("loan_term","{{current_loan_term}}");

          

    $("#amortization_table_parent table.dataframe").attr("class","display")
    $("#amortization_table_parent table.display").attr("border","0")
    $("#amortization_table_parent table.display").attr("style","width:100%")
    $("#amortization_table_parent table.display").attr("id","amortizationframe")

    $("#amortizationframe").dataTable(
      {
        "columnDefs": [
        { "visible": false, "targets": 0 }
        ]
      }
    );






      });
    </script>    

  {% endif %}