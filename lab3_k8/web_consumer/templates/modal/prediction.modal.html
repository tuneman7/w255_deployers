
  
<style>

  .on_top_always {
    z-index: 999 !important;
  }
  
  </style>

<br/>
<br/>
<br/>
{% if form is not none %}

<!--Don Irwin use this on the tool tip so that it will be on top always-->


<div class="container">
  <table>
    <tr>
      <td>
        <!--
        <h1 id="section_tag">Market Advice:<img src="{{overall_signal_gif}}" width=150 heigh=49 id="img1" > -- {{aggregate_signal_text}}</h1>
        -->
      </td>
      <td>&nbsp;&nbsp;</td>
      <td>
        <h3></h3>
      </td>
    </tr>
  </table>
  <table class="table">
      <tr >
          <td id="world_event_table" >
              <span class="align-middle">
                  <form method="post" class="form" action="/section_four" id="affordability_calc" name="affordability_calc">
                  <table class="table table-responsive-md table-striped table-hover ">

                      <tbody>

                        <tr>
                          <td>
                            <div class="btn-group" data-toggle="buttons">

                                <label class="btn btn-primary {% if 'MSA' in county_or_msa  %} active {% endif %}" onclick="swap_msa_county('MSA');">
                                  <input type="radio" name="options" id="option1" > MSA Analysis
                                </label>

                              <label class="btn btn-primary {% if 'County' in county_or_msa  %} active {% endif %}" onclick="swap_msa_county('County');">
                                <input type="radio" name="options" id="option2"> County Analysis
                              </label>
                            </div>
                            <script>
                            </script>
                          </td>
                          <td>
                            <table border="0">
                              <tr>
                                <td>
                                  <a onclick="render_dataset_modal('{{county_name}}')" >{{county_or_msa}} Dataset</a>                  
                                </td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>
                                  <a onclick="render_predict_dataset_modal('{{county_name}}')" >Predict Dataset</a>
                                </td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>
                                  {% if not popup %}
                                  <!--
                                    <a onclick="pop_out_county_modal()" >Pop-Out</a>
                                  -->
                                  {% endif %}
                                </td>                                
                              </tr>
                            </table>

                          </td>
                        </tr>
                        
                          <tr class="pointer">
                            <td>
                              What State Are You Analyzing?
                              {{ form.county_or_msa }}
                            </td>
                            <td>
                              {{ form.state_list(**{"onchange":"refresh_predictions(this.form.state_list.value,'',this.form.county_or_msa.value)"}) }}
                            </td>
                          </tr>
                          <tr class="pointer">
                            <td>
                              What {{county_or_msa}} Are You Analyzing?
                            </td>
                            <td>
                              {{ form.county_list(**{"onchange":"refresh_predictions(this.form.state_list.value,this.form.county_list.value,this.form.county_or_msa.value)"}) }}
                            </td>
                          </tr>

                          <!--
                          <tr>
                            <td colspan="3" align="right">
                              <button type="button" class="btn btn-primary" onclick="refresh_charts(this.form.interest_rates.value,this.form.downpayment_amt.value,this.form.monthly_allocation.value)">What can I Afford?</button>
                            </td>
                          </tr>
                          -->
                      </tbody>
                  </table>
                {{ form.csrf_token }}
                  </form>

              </span>
          </td>
          <td>
            &nbsp;&nbsp;&nbsp;
          </td>
          <td width="50%">
            <table border="0" cellspacing="0" cellpadding="0">
              <tr >
                <td colspan="4"><h4>Signal Components:</h4></td>
              </tr>

              <tr >
                
                  <td>
                    Days on Market Signal:&nbsp;&nbsp;&nbsp;
                  </td>
                  <td>
                    <a href="#dom">    
                      <img src="{{dom_signal_gif}}" width="22.5" height="21" id="img1" >
                    </a>
                    &nbsp;&nbsp;&nbsp;
                    
                    
                  </td>

    
                  <td>
                    Interest Rate Signal:&nbsp;&nbsp;&nbsp;
                  </td>
                  <td>
                    <a href="#int">
                    <img src="{{int_signal_gif}}" width="22.5" height="21" id="img1" >
                    </a>

                  </td>
              </tr>
              <tr>
                
                  <td>
                    Inventory Signal:&nbsp;&nbsp;&nbsp;
                  </td>
                  <td>
                    <a href="#inv">
                      <img src="{{inv_signal_gif}}" width="22.5" height="21" id="img1" >
                    </a>
                    &nbsp;&nbsp;&nbsp;

                  </td>


                  <td>
                    Price Signal:&nbsp;&nbsp;&nbsp;
                  </td>
                  <td>
                    <a href="#price">                                                    
                      <img src="{{price_signal_gif}}" width="22.5" height="21" id="img1" >
                    </a>
                  </td>
              </tr>
              <tr>
                                                                
                  <td>
                    Model ({{MODEL_USED}}) Signal:&nbsp;&nbsp;&nbsp;
                  </td>
                  <td>
                    <a href="#model">
                      <img src="{{model_signal_gif}}" width="22.5" height="21" id="img1" >
                    </a>
                    <a id="dom"></a><a id="int"></a>
                </td>
               <td colspan="2">
                  <table border="0" cellspacing="0" cellpadding="0">
                    <tr>
                      <td>
                        <a onclick="render_initial_model_modal()">Init Params</a>
                      </td>
                      <td>
                        &nbsp;
                      </td>                      
                      <td>
                        <a onclick="render_tuned_model_modal()">Tuned Params</a>
                      </td>
                    </tr>
                  </table>
               </td>
              </tr>
              <tr>
                <td>
                  <a onclick="how_it_started()">How It Started</a>
                </td>                
                <td>
                  <a onclick="play_closing_audio()">How it's going</a>
                </td>
                <td>

                </td>
                <td>

                </td>                
              </tr>
            </table>
          </td>
      </tr>
      <tr>
        <td colspan="3">


          <!--
            Put the stuff in
          -->

            <table border="0" cellspacing="0" cellpadding="0">


              <tr>
                
                <td class="text-nowrap" align="top" >
                  <h3>Days on Market Signal:&nbsp;&nbsp;&nbsp;<img src="{{dom_signal_gif}}" width="45" height="42"  id="img1" >
                    &nbsp;&nbsp;&nbsp;
                    <a href="#section_five">
                      <img src="{{ana_image}}" width="22.5" height="21"  id="img1" >
                    </a>                    
                  </h3>
                  {% if dom_response_text is not none %}
                  <p>{{dom_response_text | safe}}</p>
                  {% endif %}
                </td>
                <td>
          
                </td>
                <td nowrap align="top">
                  <h3>Interest Rate Signal:&nbsp;&nbsp;&nbsp;<img src="{{int_signal_gif}}" width="45" height="42" id="img1" >
                    &nbsp;&nbsp;&nbsp;
                    <a href="#section_five">
                      <img src="{{ana_image}}" width="22.5" height="21"  id="img1" >
                    </a>                                      
                  </h3>
                  {% if int_response_text is not none %}
                  <p>{{int_response_text | safe}}</p>
                  {% endif %}                    
                </td>
              </tr>
          
              
              <tr>
                <td>
                  <div id="altair-timeseries1a"></div>
                </td>
                <td>
          
                </td>
                <td>
                  <div id="altair-timeseries2"></div>
                  <a id="inv"></a><a id="price"></a>
                </td>
              </tr>
            
              <tr>
                <td nowrap>
                  <h3>Inventory Level Signal:&nbsp;&nbsp;&nbsp;<img src="{{inv_signal_gif}}" width="45" height="42" id="img1" >
                    &nbsp;&nbsp;&nbsp;
                    <a href="#section_five">
                      <img src="{{ana_image}}" width="22.5" height="21"  id="img1" >
                    </a>                                      
                  </h3>
                  {% if inv_response_text is not none %}
                  <p>{{inv_response_text | safe}}</p>
                  {% endif %}

                </td>
                <td>

                </td>
                
                <td nowrap>
                  <h3>Price Signal:&nbsp;&nbsp;&nbsp;<img src="{{price_signal_gif}}" width="45" height="42" id="img1" >
                    &nbsp;&nbsp;&nbsp;
                    <a href="#section_five">
                      <img src="{{ana_image}}" width="22.5" height="21"  id="img1" >
                    </a>                                      
                  </h3>
                  {% if price_response_text is not none %}
                  <p>{{price_response_text | safe}}</p>
                  {% endif %}
                  <a id="model"></a>
                </td>
              </tr>
          
              <tr>
                <td>
                  <div id="altair-timeseries3"></div>
                </td>
                <td>
          
                </td>
                <td>
                  <div id="altair-timeseries4"></div>
                </td>
              </tr>
              <tr>
                <td colspan="3">
                  {% if model_image_tuned is not none %}
                  <table border="0" cellspacing="0" cellpadding="0">
                    <tr>

                      <td> 
                     
                        <h3>LSTM based Temporal Neural Net Model Signal:&nbsp;&nbsp;&nbsp;<img src="{{model_signal_gif}}" width="45" height="42" id="img1" >
                        &nbsp;&nbsp;&nbsp;
                        <a href="#section_five">
                          <img src="{{ana_image}}" width="22.5" height="21"  id="img1" >
                        </a>                                          
                      </h3> </td>
                      <td></td>
                    </tr>
                    <tr>
                      <td> {{model_signal_text | safe}} </td>
                      <td></td>
                    </tr>                    
                    <tr>
                      <td colspan="2">
                        <table border="0" cellspacing="0" cellpadding="0">
                          <tr>
                            <td>
                              Model Used: <b>{{MODEL_USED}}</b> &nbsp;&nbsp;
                            </td>                      
                            <td>
                              <a onclick="render_initial_model_modal()">Init Params</a>
                            </td>
                            <td>
                              &nbsp;
                            </td>                      
                            <td>
                              <a onclick="render_tuned_model_modal()">Tuned Params</a>
                            </td>
                          </tr>
                        </table>                        
                      </td>
                    </tr>

                    <tr>
                      <td>
                        <div id="altair-timeseries5"></div>

                        <!--
                        <img src="{{model_image_tuned}}" id="img1" width="1000" height="400">
                        -->

                      </td>
                      <td>
                        
                      </td>
                    </tr>


                  </table>
                  {% endif %}
                 
                </td>
              </tr>
          
                      
            </table>
        



          <!--
            ending putting the stuff in
          -->

        </td>
      </tr>
  </table>



</div>


  <script>

  

    function set_drop_down_value(drop_down_id,value)
    {
      //console.log(value);
      for (var option of document.getElementById(drop_down_id).options)
        {
          //console.log(option.value);
        if (option.value === value)
        {
            option.selected = true;
            return;
        }
        }

    }

    function refresh_predictions(state,county,county_or_msa){

          page_loading();
          

          $.ajax({
              url: '/section_five_pred',
              type: 'post',
              data: {state:state,county:county,county_or_msa:county_or_msa},
              success: function(data){ 
                
                  $('#prediction_calc').empty();                 
                  $('#prediction_calc').html(data); 
                  $('#prediction_calc').append(data.htmlresponse); 
                  page_not_loading();
              }
          });
          
        };

        function parse(url, div) {
      var opt = { mode: "vega-lite",
          renderer: "svg",
          actions: { export: true, source: false, editor: false }
          };
      vegaEmbed("#" + div, url, opt, function (error, result) {
        vegaTooltip.vegaLite(result.view, url);
        });
        }
  
  
      $(document).ready(function () {

          page_not_loading();

          set_drop_down_value("state_list","{{state}}");
          set_drop_down_value("county_list","{{county}}");


      });

    </script>    

  {% endif %}

  {% if chart_json is not none %}
        

  <div class="modal fade" id="dataset_modal" >
    <div class="modal-dialog modal-lg" >
        <div class="modal-content modal-lg">
            <div class="modal-header modal-lg">
              <table border="0" width="100%"></table>
              <tr>
                <td>
                  <h4 class="modal-title">Raw dataset for {{county_text}}.</h4>
                </td>
                <td>
                  <button type="button" class="close" data-dismiss="modal">×</button>
                </td>
              </tr>
                
              
            </div>
            <div class="modal-body modal-lg" id="dataset_table_parent">
              <h1>
                <!--Displaying the converted table-->
                  {% for table in tables %}
                  <h2>{{titles[loop.index]}}</h2>							
                  {{ table|safe }}
                  {% endfor %}	
                </h1>        
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="predict_dataset_modal" >
    <div class="modal-dialog modal-lg" >
        <div class="modal-content modal-lg">
            <div class="modal-header modal-lg">
              <table border="0" width="100%"></table>
              <tr>
                <td>
                  <h4 class="modal-title">Predict dataset for {{county_text}}.</h4>
                </td>
                <td>
                  <button type="button" class="close" data-dismiss="modal">×</button>
                </td>
              </tr>
                
              
            </div>
            <div class="modal-body modal-lg" id="predict_dataset_table_parent">
              <h1>
                <!--Displaying the converted table-->
                  {% for table in predict_tables %}
                  <h2>{{titles[loop.index]}}</h2>							
                  {{ table|safe }}
                  {% endfor %}	
                </h1>        
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="initial_model_modal" >
    <div class="modal-dialog modal-lg" >
        <div class="modal-content modal-lg">
            <div class="modal-header modal-lg">
              <table border="0" width="100%"></table>
              <tr>
                <td>
                  <h4 class="modal-title">Model parameters (initial model) for {{county_text}}.</h4>
                </td>
                <td>
                  <button type="button" class="close" data-dismiss="modal">×</button>
                </td>
              </tr>
                
              
            </div>
            <div class="modal-body modal-lg" id="initial_model_modal_content">
              <h1>
                <!--Displaying the converted table-->
                  {{ INITIAL_HPARAMS|safe }}
                </h1>        
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="tuned_model_modal" >
    <div class="modal-dialog modal-lg" >
        <div class="modal-content modal-lg">
            <div class="modal-header modal-lg">
              <table border="0" width="100%"></table>
              <tr>
                <td>
                  <h4 class="modal-title">Model parameters (tuned model) for {{county_text}}.</h4>
                </td>
                <td>
                  <button type="button" class="close" data-dismiss="modal">×</button>
                </td>
              </tr>
                
              
            </div>
            <div class="modal-body modal-lg" id="tuned_model_modal_content">
              <h1>
                <!--Displaying the converted table-->
                  {{ TUNED_HPARAMS|safe }}
                </h1>        
            </div>
        </div>
    </div>
  </div>  

  <br />
  
  
      </div>
  <!-- Placeholder for the tooltip -->
  <div id="vis-tooltip" class="vg-tooltip"></div>
      </div>
  <!-- Render Charts -->
  <script type="text/javascript">

  function render_initial_model_modal(){
    $('#initial_model_modal').modal('show'); };  

    function render_tuned_model_modal(){
    $('#tuned_model_modal').modal('show'); };      


  function pop_out_county_modal()
  {
    url = './section_five_popout?state=' + '{{state}}' + '&county=' + '{{county}}' +  '&popup=' + '{{popup}}' +  '&county_or_msa=' + '{{county_or_msa}}' 
    window.open(url,'','toolbar=no');
  }



  function how_it_started()
  {
    window.open('./static/pdfs/w210_project_proposal.pdf','','toolbar=no');
  }
  
  function play_closing_audio()
  {
    var audio = new Audio("./static/audio/cant_do_it_like_me_4.mp3")
    audio.play()
  }

  function swap_msa_county(the_value){

    county_or_msa = $("#county_or_msa").val();
    if(county_or_msa == the_value)
    {return;}

    $("#county_or_msa").val(the_value);
    state = $("#state_list").val();
    county = "";
    refresh_predictions(state,county,the_value);
    


    };


  {% if chart_json is not none %}

  $(document).ready(function () {






    $("#predict_dataset_table_parent table.dataframe").attr("class","display");
    $("#predict_dataset_table_parent table.display").attr("border","0");
    $("#predict_dataset_table_parent table.display").attr("style","width:100%");
    $("#predict_dataset_table_parent table.display").attr("id","mypredictdataframe");

    $("#mypredictdataframe").dataTable( 
  //     {
  //     "columns": [
  //       null,
  //       { "width": "15%" },
  //       { "width": "15%" },
  //       null,
  //       null,
  //       null, 
  //       null,
  //       null
  //     ],
  //     "columnDefs": [
  //   { "visible": false, "targets": 1 }
  // ],
  //     "buttons": [
  //         'copy', 'csv', 'excel', 'pdf', 'print'
  //     ]        
  //   }
     );



    $("#dataset_table_parent table.dataframe").attr("class","display");
    $("#dataset_table_parent table.display").attr("border","0");
    $("#dataset_table_parent table.display").attr("style","width:100%");
    $("#dataset_table_parent table.display").attr("id","mydataframe");

    $("#mydataframe").dataTable( {
      "columns": [
        null,
        { "width": "15%" },
        { "width": "15%" },
        null,
        null,
        null, 
        null,
        null
      ],
      "columnDefs": [
    { "visible": false, "targets": 1 }
  ],
      "buttons": [
          'copy', 'csv', 'excel', 'pdf', 'print'
      ]        
    } );




  //Parse your Json variable here
  parse({{ chart_json | safe }}, "altair-timeseries1a");
  parse({{ chart_json1 | safe }}, "altair-timeseries2");
  parse({{ chart_json2 | safe }}, "altair-timeseries3");
  parse({{ chart_json3 | safe }}, "altair-timeseries4");
  parse({{ model_json | safe }}, "altair-timeseries5");

  });


  function render_predict_dataset_modal(county_name){
    $('#predict_dataset_modal').modal('show'); };  

  function render_dataset_modal(county_name){
    $('#dataset_modal').modal('show'); };


  {% endif %}

  
  </script>
  
    {% endif %}
  